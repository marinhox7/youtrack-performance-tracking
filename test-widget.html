<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - iMarinho Performance Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .logs-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .widget-frame {
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 100%;
            height: 600px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Teste do iMarinho Performance Dashboard</h1>

        <div class="test-info">
            <strong>üìã Status:</strong> Este √© um ambiente de teste para debug do widget YouTrack.<br>
            <strong>üîç Debug:</strong> Logs detalhados ser√£o exibidos no console do navegador.<br>
            <strong>üí° Instru√ß√µes:</strong> Abra o DevTools (F12) para ver os logs de debug detalhados.
        </div>

        <div class="logs-container" id="logsContainer">
            <div>üöÄ Console de Debug Iniciado...</div>
            <div>üìä Aguardando carregamento do widget...</div>
        </div>

        <iframe src="youtrack-app/widgets/dashboard-suite/index.html"
                class="widget-frame"
                id="widgetFrame">
        </iframe>
    </div>

    <script>
        // Mock do YTApp para simular o ambiente YouTrack
        window.YTApp = {
            register: async function(config) {
                console.log('üîå YTApp.register chamado com config:', config);

                // Simular um host b√°sico
                const mockHost = {
                    setTitle: function(title) {
                        console.log('üìù setTitle:', title);
                        document.title = title;
                    },

                    resize: function(width, height) {
                        console.log('üìê resize:', width, 'x', height);
                    },

                    setLoadingAnimationEnabled: function(enabled) {
                        console.log('‚è≥ setLoadingAnimationEnabled:', enabled);
                    },

                    clearError: function() {
                        console.log('üßπ clearError');
                    },

                    setError: function(error) {
                        console.error('‚ùå setError:', error);
                        this.addLog('‚ùå ERRO: ' + error, 'error');
                    },

                    // Mock da API YouTrack
                    fetchYouTrack: async function(endpoint, params) {
                        console.log('üì° fetchYouTrack chamado:', endpoint, params);

                        // Simular erro para testar debug
                        if (endpoint.includes('admin/projects')) {
                            // Simular resposta de projetos vazia
                            return [];
                        }

                        if (endpoint.includes('issues')) {
                            // Simular erro de campo Sprints
                            throw new Error('Cannot resolve symbol \'Sprints\' in query. Field \'Sprints\' not found.');
                        }

                        // Para outros endpoints, simular erro 404
                        throw new Error('404 Not Found');
                    },

                    // Fun√ß√£o para adicionar logs na tela
                    addLog: function(message, type = 'info') {
                        const logsContainer = parent.document.getElementById('logsContainer');
                        if (logsContainer) {
                            const logDiv = parent.document.createElement('div');
                            logDiv.style.color = type === 'error' ? '#ff4444' : type === 'warn' ? '#ffaa00' : '#00ff00';
                            logDiv.textContent = new Date().toLocaleTimeString() + ' ' + message;
                            logsContainer.appendChild(logDiv);
                            logsContainer.scrollTop = logsContainer.scrollHeight;
                        }
                    }
                };

                // Interceptar console.log para mostrar na tela
                const originalLog = console.log;
                const originalWarn = console.warn;
                const originalError = console.error;

                console.log = function(...args) {
                    originalLog.apply(console, args);
                    mockHost.addLog(args.join(' '), 'info');
                };

                console.warn = function(...args) {
                    originalWarn.apply(console, args);
                    mockHost.addLog(args.join(' '), 'warn');
                };

                console.error = function(...args) {
                    originalError.apply(console, args);
                    mockHost.addLog(args.join(' '), 'error');
                };

                return mockHost;
            }
        };

        // Injeta o YTApp no iframe quando carregar
        document.getElementById('widgetFrame').onload = function() {
            try {
                const iframeWindow = this.contentWindow;
                iframeWindow.YTApp = window.YTApp;
                console.log('‚úÖ YTApp injetado no iframe com sucesso');
            } catch (e) {
                console.error('‚ùå Erro ao injetar YTApp:', e);
            }
        };
    </script>
</body>
</html>