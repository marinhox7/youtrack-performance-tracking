<!DOCTYPE html>
<!--
    Performance Dashboard Suite Widget
    Developed by: iMarinho Team
    Description: YouTrack performance metrics dashboard with 4 main KPI cards
-->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Dashboard Suite</title>
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif !important;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            background: #ffffff;
            color: #333333;
            font-size: 13px;
            line-height: 1.4;
        }

        .dashboard-container {
            padding: 16px;
            max-width: 100%;
            overflow-x: auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .dashboard-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .refresh-button {
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .refresh-button:hover {
            background: #0052a3;
        }

        .refresh-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .error {
            background: #fff2f2;
            border: 1px solid #ffc6c6;
            color: #cc0000;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            transition: box-shadow 0.2s;
        }

        .metric-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .metric-card-success {
            border-left: 4px solid #28a745;
        }

        .metric-card-success .metric-value {
            color: #28a745;
        }

        .metric-card-warning {
            border-left: 4px solid #ffc107;
        }

        .metric-card-warning .metric-value {
            color: #e67e22;
        }

        .metric-card-critical {
            border-left: 4px solid #dc3545;
        }

        .metric-card-critical .metric-value {
            color: #dc3545;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Performance Dashboard</h1>
            <button class="refresh-button" id="refreshBtn" onclick="loadData()">
                Atualizar
            </button>
        </div>

        <div id="loading" class="loading">
            Carregando dados...
        </div>

        <div id="error" class="error hidden">
            <!-- Mensagens de erro aparecer√£o aqui -->
        </div>

        <div id="content" class="hidden">
            <div class="metrics-grid" id="metricsGrid">
                <!-- Cards de m√©tricas aparecer√£o aqui -->
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Performance Dashboard inicializando...');

        // Estado global do dashboard
        let dashboardData = {
            issues: [],
            metrics: {}
        };

        // Fun√ß√£o para mostrar loading
        function showLoading(show = true) {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            const refreshBtn = document.getElementById('refreshBtn');

            if (show) {
                loading.classList.remove('hidden');
                content.classList.add('hidden');
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Carregando...';
            } else {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Atualizar';
            }
        }

        // Fun√ß√£o para mostrar erro
        function showError(message, type = 'error') {
            const errorDiv = document.getElementById('error');

            // Limpar classes existentes
            errorDiv.className = 'error';

            // Adicionar classe baseada no tipo
            if (type === 'warning') {
                errorDiv.style.background = '#fff8e1';
                errorDiv.style.borderColor = '#ffcc02';
                errorDiv.style.color = '#f57c00';
            } else {
                errorDiv.style.background = '#fff2f2';
                errorDiv.style.borderColor = '#ffc6c6';
                errorDiv.style.color = '#cc0000';
            }

            errorDiv.textContent = message;
            if (message) {
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.classList.add('hidden');
            }
        }

        // Fun√ß√£o para esconder erro
        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        // Fun√ß√£o principal para carregar dados
        async function loadDashboardData() {
            console.log('üì° Carregando dados do dashboard...');

            try {
                showLoading(true);
                showError('');

                // Tentar buscar dados reais primeiro
                try {
                    const issues = await fetchYouTrackIssues();
                    dashboardData.issues = issues;
                    console.log('‚úÖ Dados reais carregados:', issues.length, 'issues');
                } catch (apiError) {
                    console.log('‚ö†Ô∏è API n√£o dispon√≠vel, usando dados de exemplo:', apiError.message);

                    // Usar dados de exemplo mais realistas
                    dashboardData.issues = generateRealisticExampleData();

                    // Mostrar aviso mais informativo
                    if (window.location.href.includes('about:') || window.location.href.includes('srcdoc')) {
                        showError('üí° Widget rodando em modo de demonstra√ß√£o - usando dados de exemplo da iMarinho', 'warning');
                    } else {
                        showError('‚ö†Ô∏è API YouTrack n√£o acess√≠vel - exibindo dados de exemplo', 'warning');
                    }
                }

                calculateMetrics();
                renderDashboard();

            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar dashboard:', error);
                showError('‚ùå Erro ao carregar dados: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Wrapper para compatibilidade
        async function loadData() {
            await loadDashboardData();
        }

        // Fun√ß√£o para detectar URL base do YouTrack
        function detectYouTrackBaseUrl() {
            try {
                // Prioridade 1: Tentar acessar contexto do widget YT
                if (typeof YT !== 'undefined' && YT.host) {
                    console.log('‚úÖ Contexto YT dispon√≠vel, usando URLs relativas');
                    return '';  // Use URLs relativas quando YT est√° dispon√≠vel
                }

                // Prioridade 2: Verificar se h√° contexto de widget mesmo sem YT global
                if (window.parent && window.parent !== window) {
                    try {
                        // Widget rodando em iframe - tentar acessar parent
                        const parentHref = window.parent.location.href;
                        if (parentHref && !parentHref.startsWith('about:') && parentHref.includes('youtrack')) {
                            const url = new URL(parentHref);
                            const baseUrl = `${url.protocol}//${url.host}`;
                            console.log('üåê URL base do parent iframe:', baseUrl);
                            return baseUrl;
                        }
                    } catch (e) {
                        console.log('‚ö†Ô∏è Parent window inacess√≠vel (CORS/sandbox)');
                    }
                }

                // Prioridade 3: Verificar URL atual (n√£o √© about: ou srcdoc)
                if (window.location.href &&
                    !window.location.href.startsWith('about:') &&
                    !window.location.href.includes('srcdoc')) {
                    const url = new URL(window.location.href);
                    const baseUrl = `${url.protocol}//${url.host}`;
                    console.log('üåê URL base da p√°gina atual:', baseUrl);
                    return baseUrl;
                }

                // Prioridade 4: Verificar se estamos em contexto YouTrack via DOM
                try {
                    if (window.parent && window.parent.document) {
                        const parentTitle = window.parent.document.title;
                        if (parentTitle && parentTitle.includes('YouTrack')) {
                            console.log('üåê Detectado contexto YouTrack pelo t√≠tulo');
                            return 'https://braiphub.youtrack.cloud'; // Usar fallback seguro
                        }
                    }
                } catch (e) {
                    // Ignorar erro de acesso cross-origin
                }

                // Fallback final: usar configura√ß√£o conhecida
                console.log('‚ö†Ô∏è Usando URL hardcoded como fallback final');
                return 'https://braiphub.youtrack.cloud';

            } catch (error) {
                console.error('‚ùå Erro ao detectar URL base:', error);
                return 'https://braiphub.youtrack.cloud';
            }
        }

        // Fun√ß√£o corrigida para usar API do YouTrack em widget
        async function fetchWithAuth(url) {
            console.log('üîç Fazendo requisi√ß√£o para:', url);

            try {
                // Estrat√©gia 1: Tentar acessar YT global via diferentes caminhos
                let YTObject = null;

                // Tentar YT direto
                if (typeof YT !== 'undefined') {
                    YTObject = YT;
                    console.log('‚úÖ YT encontrado globalmente');
                }

                // Tentar via window
                else if (typeof window.YT !== 'undefined') {
                    YTObject = window.YT;
                    console.log('‚úÖ YT encontrado via window.YT');
                }

                // Tentar via parent window
                else if (window.parent && typeof window.parent.YT !== 'undefined') {
                    YTObject = window.parent.YT;
                    console.log('‚úÖ YT encontrado via window.parent.YT');
                }

                // Tentar via top window
                else if (window.top && typeof window.top.YT !== 'undefined') {
                    YTObject = window.top.YT;
                    console.log('‚úÖ YT encontrado via window.top.YT');
                }

                // Se encontrou YT, tentar usar
                if (YTObject && YTObject.fetch) {
                    console.log('‚úÖ Usando YT.fetch (API nativa do widget)');
                    const relativeUrl = url.replace(/^https?:\/\/[^\/]+/, '');
                    console.log('üìç URL relativa para YT.fetch:', relativeUrl);

                    const response = await YTObject.fetch(relativeUrl);

                    if (!response.ok) {
                        throw new Error(`YT.fetch HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('‚úÖ Dados recebidos via YT.fetch:', data.length, 'issues');
                    return data;
                }

                // Estrat√©gia 2: Tentar via postMessage para parent
                if (window.parent && window.parent !== window) {
                    console.log('üîÑ Tentando comunica√ß√£o via postMessage com parent');

                    return new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Timeout na comunica√ß√£o com parent window'));
                        }, 10000);

                        const messageHandler = (event) => {
                            if (event.data && event.data.type === 'YOUTRACK_API_RESPONSE') {
                                clearTimeout(timeout);
                                window.removeEventListener('message', messageHandler);

                                if (event.data.success) {
                                    console.log('‚úÖ Dados recebidos via postMessage:', event.data.data.length, 'issues');
                                    resolve(event.data.data);
                                } else {
                                    reject(new Error(event.data.error));
                                }
                            }
                        };

                        window.addEventListener('message', messageHandler);

                        const relativeUrl = url.replace(/^https?:\/\/[^\/]+/, '');
                        window.parent.postMessage({
                            type: 'YOUTRACK_API_REQUEST',
                            url: relativeUrl
                        }, '*');
                    });
                }

                // Estrat√©gia 3: fetch normal com URL relativa (√∫ltima tentativa)
                console.log('üîÑ Tentando fetch padr√£o com URL relativa');
                const relativeUrl = url.replace(/^https?:\/\/[^\/]+/, '');
                console.log('üìç URL relativa para fetch:', relativeUrl);

                const response = await fetch(relativeUrl, {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Fetch HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Dados recebidos via fetch padr√£o:', data.length, 'issues');
                return data;

            } catch (error) {
                console.error('üí• Erro na requisi√ß√£o:', error.message);

                // Log detalhado para debug
                console.log('üîß Contexto de debug:', {
                    'URL original': url,
                    'YT global': typeof YT !== 'undefined',
                    'window.YT': typeof window.YT !== 'undefined',
                    'parent.YT': window.parent && typeof window.parent.YT !== 'undefined',
                    'top.YT': window.top && typeof window.top.YT !== 'undefined',
                    'window.location': window.location.href,
                    '√â iframe': window.parent !== window,
                    'Parent acess√≠vel': window.parent !== window && window.parent
                });

                throw error;
            }
        }

        // Fun√ß√£o para aguardar carregamento do YT
        function waitForYT(timeout = 5000) {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = timeout / 100;

                const checkYT = () => {
                    attempts++;

                    // Verificar diferentes caminhos para YT
                    if (typeof YT !== 'undefined' && YT.fetch) {
                        console.log('‚úÖ YT carregado ap√≥s', attempts * 100, 'ms');
                        resolve(YT);
                        return;
                    }

                    if (typeof window.YT !== 'undefined' && window.YT.fetch) {
                        console.log('‚úÖ window.YT carregado ap√≥s', attempts * 100, 'ms');
                        resolve(window.YT);
                        return;
                    }

                    if (window.parent && typeof window.parent.YT !== 'undefined' && window.parent.YT.fetch) {
                        console.log('‚úÖ parent.YT carregado ap√≥s', attempts * 100, 'ms');
                        resolve(window.parent.YT);
                        return;
                    }

                    if (window.top && typeof window.top.YT !== 'undefined' && window.top.YT.fetch) {
                        console.log('‚úÖ top.YT carregado ap√≥s', attempts * 100, 'ms');
                        resolve(window.top.YT);
                        return;
                    }

                    if (attempts < maxAttempts) {
                        setTimeout(checkYT, 100);
                    } else {
                        console.log('‚è∞ Timeout aguardando YT ap√≥s', timeout, 'ms');
                        resolve(null);
                    }
                };

                checkYT();
            });
        }

        // Fun√ß√£o para buscar issues reais do YouTrack
        async function fetchYouTrackIssues() {
            console.log('üîç Buscando dados reais do YouTrack...');

            // Tentar aguardar carregamento do YT primeiro
            console.log('‚è≥ Aguardando carregamento do YT...');
            const YTObject = await waitForYT(3000);

            if (YTObject) {
                console.log('‚úÖ YT carregado, usando API nativa');
                const query = 'created: -30d .. now';
                const fields = 'id,idReadable,created,resolved,state(name),priority(name),project(name,shortName),assignee(name,fullName)';
                const relativeUrl = `/api/issues?fields=${fields}&query=${encodeURIComponent(query)}&$top=1000`;

                try {
                    const response = await YTObject.fetch(relativeUrl);
                    if (!response.ok) {
                        throw new Error(`YT.fetch HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log('‚úÖ Dados carregados via YT.fetch:', data.length, 'issues');
                    return data;
                } catch (error) {
                    console.error('‚ùå Erro com YT.fetch:', error.message);
                    // Continuar para fallback
                }
            }

            // Fallback para m√©todo anterior
            const baseUrl = detectYouTrackBaseUrl();
            const query = 'created: -30d .. now';
            const fields = 'id,idReadable,created,resolved,state(name),priority(name),project(name,shortName),assignee(name,fullName)';

            const url = `${baseUrl}/api/issues?fields=${fields}&query=${encodeURIComponent(query)}&$top=1000`;

            return await fetchWithAuth(url);
        }


        // Gerar dados de exemplo realistas
        function generateRealisticExampleData() {
            console.log('üìù Gerando dados de exemplo realistas...');

            const data = [];

            // Estados reais em MAI√öSCULAS
            const states = [
                'DONE', 'CLOSED', 'PRODUCTION',           // Resolvidos
                'IN DEVELOPMENT', 'CORRECTION', 'READY TO REVIEW', 'REVIEWING', 'APPROVED', // Ativos
                'OPEN', 'PAUSED',                         // Outros estados
                'BACKLOG', 'MOVED TO NEXT SPRINT'         // Ignorados
            ];

            const priorities = ['Low', 'Normal', 'High', 'Critical'];
            const projects = [
                { name: 'Performance Dashboard', shortName: 'PERF' },
                { name: 'YouTrack Integration', shortName: 'YT' },
                { name: 'Analytics Platform', shortName: 'ANAL' },
                { name: 'Reporting Tools', shortName: 'REP' }
            ];

            // Gerar 50 issues de exemplo com distribui√ß√£o realista
            for (let i = 1; i <= 50; i++) {
                const project = projects[Math.floor(Math.random() * projects.length)];

                // Distribui√ß√£o mais realista dos estados
                let state;
                const rand = Math.random();
                if (rand < 0.3) {
                    // 30% resolvidos
                    state = ['DONE', 'CLOSED', 'PRODUCTION'][Math.floor(Math.random() * 3)];
                } else if (rand < 0.7) {
                    // 40% ativos
                    state = ['IN DEVELOPMENT', 'CORRECTION', 'READY TO REVIEW', 'REVIEWING', 'APPROVED'][Math.floor(Math.random() * 5)];
                } else if (rand < 0.85) {
                    // 15% outros estados
                    state = ['OPEN', 'PAUSED'][Math.floor(Math.random() * 2)];
                } else {
                    // 15% ignorados
                    state = ['BACKLOG', 'MOVED TO NEXT SPRINT'][Math.floor(Math.random() * 2)];
                }

                const priority = priorities[Math.floor(Math.random() * priorities.length)];

                data.push({
                    id: i.toString(),
                    idReadable: `${project.shortName}-${i}`,
                    state: { name: state },
                    priority: { name: priority },
                    project: project,
                    assignee: {
                        name: `imarinho${i % 5}`,
                        fullName: `iMarinho Dev ${i % 5}`
                    },
                    created: Date.now() - (Math.random() * 30 * 24 * 60 * 60 * 1000),
                    resolved: ['DONE', 'CLOSED', 'PRODUCTION'].includes(state)
                        ? Date.now() - (Math.random() * 15 * 24 * 60 * 60 * 1000)
                        : null
                });
            }

            console.log('üìä Dados de exemplo gerados:', {
                total: data.length,
                porEstado: data.reduce((acc, issue) => {
                    acc[issue.state.name] = (acc[issue.state.name] || 0) + 1;
                    return acc;
                }, {})
            });

            return data;
        }

        // Gerar dados de exemplo (compatibilidade)
        function generateExampleData() {
            return generateRealisticExampleData();
        }

        // Calcular m√©tricas
        function calculateMetrics() {
            console.log('üî¢ Calculando m√©tricas...');

            const issues = dashboardData.issues;

            // Estados que devem ser IGNORADOS do c√°lculo (em mai√∫sculas)
            const excludedStates = [
                'BACKLOG',
                'MOVED TO NEXT SPRINT'
            ];

            // Estados considerados como RESOLVIDOS (em mai√∫sculas)
            const resolvedStates = [
                'DONE',
                'CLOSED',
                'PRODUCTION'
            ];

            // Estados considerados como ATIVOS (em mai√∫sculas)
            const activeStates = [
                'IN DEVELOPMENT',
                'CORRECTION',
                'READY TO REVIEW',
                'REVIEWING',
                'APPROVED'
            ];

            // Filtrar issues exclu√≠das (ignorar BACKLOG e MOVED TO NEXT SPRINT)
            const validIssues = issues.filter(issue => {
                const state = (issue.state?.name || '').toUpperCase().trim();
                return !excludedStates.includes(state);
            });

            const total = validIssues.length;

            // Contar issues resolvidas (DONE, CLOSED, PRODUCTION)
            const resolved = validIssues.filter(issue => {
                const state = (issue.state?.name || '').toUpperCase().trim();
                return resolvedStates.includes(state);
            }).length;

            // Contar issues ativas (IN DEVELOPMENT, CORRECTION, READY TO REVIEW, REVIEWING, APPROVED)
            const active = validIssues.filter(issue => {
                const state = (issue.state?.name || '').toUpperCase().trim();
                return activeStates.includes(state);
            }).length;

            // Taxa de conclus√£o: (Resolvidas √∑ Total v√°lidas) √ó 100
            const completionRate = total > 0 ? Math.round((resolved / total) * 100) : 0;

            // Contar projetos √∫nicos (apenas issues v√°lidas)
            const uniqueProjects = new Set(
                validIssues
                    .map(issue => issue.project?.name)
                    .filter(Boolean)
            ).size;

            dashboardData.metrics = {
                total,
                resolved,
                active,
                completionRate,
                projects: uniqueProjects
            };

            console.log('üìä M√©tricas calculadas:', {
                'Total de Issues (v√°lidas)': total,
                'Issues Resolvidas': resolved,
                'Issues Ativas': active,
                'Estados resolvidos': resolvedStates.join(', '),
                'Estados ativos': activeStates.join(', '),
                'Estados ignorados': excludedStates.join(', '),
                'Taxa de Conclus√£o': completionRate + '%',
                'Projetos √önicos': uniqueProjects,
                'Issues exclu√≠das do c√°lculo': issues.length - total
            });
        }

        // Renderizar dashboard
        function renderDashboard() {
            console.log('üé® Renderizando dashboard...');
            renderMetrics();
        }

        // Renderizar m√©tricas
        function renderMetrics() {
            const metrics = dashboardData.metrics;
            const grid = document.getElementById('metricsGrid');

            // Determinar cor do card de taxa de conclus√£o
            const completionClass = metrics.completionRate >= 80 ? 'success' :
                                   metrics.completionRate >= 60 ? 'warning' : 'critical';

            grid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${metrics.total}</div>
                    <div class="metric-label">Total de Issues</div>
                </div>
                <div class="metric-card metric-card-success">
                    <div class="metric-value">${metrics.resolved}</div>
                    <div class="metric-label">Issues Resolvidas</div>
                </div>
                <div class="metric-card metric-card-warning">
                    <div class="metric-value">${metrics.active}</div>
                    <div class="metric-label">Issues Ativas</div>
                </div>
                <div class="metric-card metric-card-${completionClass}">
                    <div class="metric-value">${metrics.completionRate}%</div>
                    <div class="metric-label">Taxa de Conclus√£o</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.projects}</div>
                    <div class="metric-label">Projetos</div>
                </div>
            `;
        }

        // Inicializar dashboard quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåü DOM carregado, inicializando dashboard...');
            loadData();
        });

        console.log('‚úÖ Performance Dashboard configurado');
    </script>
</body>
</html>