<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Dashboard Suite</title>
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif !important;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            background: #ffffff;
            color: #333333;
            font-size: 13px;
            line-height: 1.4;
        }

        .dashboard-container {
            padding: 16px;
            max-width: 100%;
            overflow-x: auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e5e5;
        }

        .dashboard-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .refresh-button {
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .refresh-button:hover {
            background: #0052a3;
        }

        .refresh-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .error {
            background: #fff2f2;
            border: 1px solid #ffc6c6;
            color: #cc0000;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            transition: box-shadow 0.2s;
        }

        .metric-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .metric-card-success {
            border-left: 4px solid #28a745;
        }

        .metric-card-success .metric-value {
            color: #28a745;
        }

        .metric-card-warning {
            border-left: 4px solid #ffc107;
        }

        .metric-card-warning .metric-value {
            color: #e67e22;
        }

        .metric-card-critical {
            border-left: 4px solid #dc3545;
        }

        .metric-card-critical .metric-value {
            color: #dc3545;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Performance Dashboard</h1>
            <button class="refresh-button" id="refreshBtn" onclick="loadData()">
                Atualizar
            </button>
        </div>

        <div id="loading" class="loading">
            Carregando dados...
        </div>

        <div id="error" class="error hidden">
            <!-- Mensagens de erro aparecer√£o aqui -->
        </div>

        <div id="content" class="hidden">
            <div class="metrics-grid" id="metricsGrid">
                <!-- Cards de m√©tricas aparecer√£o aqui -->
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Performance Dashboard inicializando...');

        // Estado global do dashboard
        let dashboardData = {
            issues: [],
            metrics: {}
        };

        // Fun√ß√£o para mostrar loading
        function showLoading(show = true) {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            const refreshBtn = document.getElementById('refreshBtn');

            if (show) {
                loading.classList.remove('hidden');
                content.classList.add('hidden');
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Carregando...';
            } else {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Atualizar';
            }
        }

        // Fun√ß√£o para mostrar erro
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Fun√ß√£o para esconder erro
        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        // Fun√ß√£o principal para carregar dados
        async function loadData() {
            console.log('üìä Carregando dados do dashboard...');

            showLoading(true);
            hideError();

            try {
                // Tentar buscar dados reais da API do YouTrack
                let issues = [];
                let useRealData = false;

                try {
                    issues = await fetchYouTrackIssues();
                    useRealData = true;
                    console.log('‚úÖ Dados reais carregados da API do YouTrack');
                } catch (apiError) {
                    console.warn('‚ö†Ô∏è API indispon√≠vel, usando dados de exemplo:', apiError.message);
                    issues = generateExampleData();
                    showError('Usando dados de exemplo - API n√£o acess√≠vel');
                }

                dashboardData.issues = issues;
                calculateMetrics();
                renderDashboard();

                console.log('‚úÖ Dashboard carregado com sucesso', {
                    totalIssues: issues.length,
                    dataSource: useRealData ? 'API Real' : 'Dados de Exemplo'
                });

            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
                showError('Erro ao carregar dados: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Fun√ß√£o para buscar issues reais do YouTrack
        async function fetchYouTrackIssues() {
            console.log('üîç Buscando dados reais do YouTrack...');

            // Tentar usar API nativa do YouTrack se dispon√≠vel
            if (typeof YT !== 'undefined' && YT.fetch) {
                console.log('‚úÖ Usando YT.fetch (API nativa do widget)');
                return await fetchWithYouTrackAPI();
            }

            // Fallback para fetch normal com configura√ß√£o de widget
            console.log('üîÑ Tentando fetch normal com configura√ß√£o de widget');
            return await fetchWithStandardAPI();
        }

        // Buscar com API nativa do YouTrack
        async function fetchWithYouTrackAPI() {
            const query = 'created: -30d .. now'; // √öltimas 4 semanas
            const fields = 'id,idReadable,created,resolved,state(name),priority(name),project(name,shortName),assignee(name,fullName)';

            const url = `/api/issues?fields=${fields}&query=${encodeURIComponent(query)}&$top=1000`;

            console.log('üåê Fazendo requisi√ß√£o via YT.fetch:', url);

            const response = await YT.fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('üìä Issues recebidas:', data.length);

            return data;
        }

        // Buscar com API padr√£o
        async function fetchWithStandardAPI() {
            // Para widgets, tentar usar URL relativa
            const query = 'created: -30d .. now';
            const fields = 'id,idReadable,created,resolved,state(name),priority(name),project(name,shortName),assignee(name,fullName)';

            const url = `./api/issues?fields=${fields}&query=${encodeURIComponent(query)}&$top=1000`;

            console.log('üåê Fazendo requisi√ß√£o via fetch padr√£o:', url);

            const response = await fetch(url, {
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('üìä Issues recebidas:', data.length);

            return data;
        }

        // Gerar dados de exemplo
        function generateExampleData() {
            console.log('üìù Gerando dados de exemplo...');

            const data = [];
            const states = ['Aberto', 'Em Progresso', 'Resolvido', 'Fechado', 'Done'];
            const priorities = ['Baixa', 'M√©dia', 'Alta', 'Cr√≠tica'];
            const projects = [
                { name: 'Dashboard Performance', shortName: 'DASH' },
                { name: 'YouTrack Widgets', shortName: 'YTW' },
                { name: 'Analytics Suite', shortName: 'ANAL' },
                { name: 'Reporting Tools', shortName: 'REP' }
            ];
            const assignees = [
                { name: 'dev1', fullName: 'Jo√£o Silva' },
                { name: 'dev2', fullName: 'Maria Santos' },
                { name: 'dev3', fullName: 'Pedro Costa' },
                { name: 'dev4', fullName: 'Ana Oliveira' }
            ];

            for (let i = 1; i <= 25; i++) {
                const project = projects[Math.floor(Math.random() * projects.length)];
                const state = states[Math.floor(Math.random() * states.length)];
                const priority = priorities[Math.floor(Math.random() * priorities.length)];
                const assignee = assignees[Math.floor(Math.random() * assignees.length)];

                data.push({
                    id: i.toString(),
                    idReadable: `${project.shortName}-${i}`,
                    state: { name: state },
                    priority: { name: priority },
                    project: project,
                    assignee: assignee,
                    created: Date.now() - (Math.random() * 30 * 24 * 60 * 60 * 1000),
                    resolved: state === 'Resolvido' || state === 'Fechado' || state === 'Done'
                        ? Date.now() - (Math.random() * 15 * 24 * 60 * 60 * 1000)
                        : null
                });
            }

            console.log('üìä Dados de exemplo gerados:', {
                totalIssues: data.length,
                projects: [...new Set(data.map(d => d.project.name))].length,
                states: [...new Set(data.map(d => d.state.name))]
            });

            return data;
        }

        // Calcular m√©tricas
        function calculateMetrics() {
            console.log('üî¢ Calculando m√©tricas...');

            const issues = dashboardData.issues;
            const total = issues.length;

            // Detectar issues resolvidas baseadas no estado
            const resolved = issues.filter(issue => {
                const state = (issue.state?.name || '').toLowerCase();
                return state.includes('resolvido') ||
                       state.includes('resolved') ||
                       state.includes('fechado') ||
                       state.includes('closed') ||
                       state.includes('conclu√≠do') ||
                       state.includes('completed') ||
                       state.includes('done');
            }).length;

            // Issues ativas = Total - Resolvidas
            const active = total - resolved;

            // Taxa de conclus√£o: (Resolvidas √∑ Total) √ó 100
            const completionRate = total > 0 ? Math.round((resolved / total) * 100) : 0;

            // Contar projetos √∫nicos
            const uniqueProjects = new Set(
                issues
                    .map(issue => issue.project?.name)
                    .filter(Boolean)
            ).size;

            dashboardData.metrics = {
                total,
                resolved,
                active,
                completionRate,
                projects: uniqueProjects
            };

            console.log('üìä M√©tricas calculadas:', {
                'Total de Issues': total,
                'Issues Resolvidas': resolved,
                'Issues Ativas': active,
                'Taxa de Conclus√£o': completionRate + '%',
                'Projetos √önicos': uniqueProjects
            });
        }

        // Renderizar dashboard
        function renderDashboard() {
            console.log('üé® Renderizando dashboard...');
            renderMetrics();
        }

        // Renderizar m√©tricas
        function renderMetrics() {
            const metrics = dashboardData.metrics;
            const grid = document.getElementById('metricsGrid');

            // Determinar cor do card de taxa de conclus√£o
            const completionClass = metrics.completionRate >= 80 ? 'success' :
                                   metrics.completionRate >= 60 ? 'warning' : 'critical';

            grid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${metrics.total}</div>
                    <div class="metric-label">Total de Issues</div>
                </div>
                <div class="metric-card metric-card-success">
                    <div class="metric-value">${metrics.resolved}</div>
                    <div class="metric-label">Issues Resolvidas</div>
                </div>
                <div class="metric-card metric-card-warning">
                    <div class="metric-value">${metrics.active}</div>
                    <div class="metric-label">Issues Ativas</div>
                </div>
                <div class="metric-card metric-card-${completionClass}">
                    <div class="metric-value">${metrics.completionRate}%</div>
                    <div class="metric-label">Taxa de Conclus√£o</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.projects}</div>
                    <div class="metric-label">Projetos</div>
                </div>
            `;
        }

        // Inicializar dashboard quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåü DOM carregado, inicializando dashboard...');
            loadData();
        });

        console.log('‚úÖ Performance Dashboard configurado');
    </script>
</body>
</html>